<!DOCTYPE html>
<!--<html lang="en" manifest="clock.manifest">-->
<html>
<head>
<meta charset=utf-8 />
<title>HTML5 Clock</title>
<!--[if IE]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->


<!-- For mobile and tablet devices -->
	<meta name="viewport" id="viewport" content="width=device-width, user-scalable=no, minimum-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">


<style>


	@font-face {
	    font-family: 'Digital7Mono';
	    src: url('digital-7_mono-webfont.eot');
	    src: url('digital-7_mono-webfont.eot?#iefix') format('embedded-opentype'),
	         url('digital-7_mono-webfont.woff') format('woff'),
	         url('digital-7_mono-webfont.ttf') format('truetype'),
	         url('digital-7_mono-webfont.svg#Digital7Mono') format('svg');
	    font-weight: normal;
	    font-style: normal;


	}


  /* Base reset and layout */
  html, body { height: 100%; }
  body{
    margin: 0;
    background: #000;
    display: grid;
    place-items: center;
    min-height: 100vh;
  }

  /* Center and scale the canvas responsively */
  #c{
    display: block;
    height: clamp(300px, 92vmin, 1600px);
    width: auto;
  }

  /* Very large displays (e.g., 4K) */
  @media (min-width: 2560px) {
    #c { height: 95vmin; }
  }

  /* iPhones and small phones */
  @media (max-width: 480px) {
    #c { height: 96vmin; }
  }

  /* iPads and tablets */
  @media (min-width: 768px) and (max-width: 1024px) {
    #c { height: 88vmin; }
  }

  /* Settings button */
  .settings-btn {
    position: fixed;
    top: 12px;
    right: 12px;
    background: #222;
    color: #fff;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 6px 10px;
    font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    cursor: pointer;
  }

  /* Dialog (modal) styles */
  dialog {
    border: 1px solid #333;
    border-radius: 10px;
    padding: 0;
    width: min(92vw, 420px);
    color: #eaeaea;
    background: #121212;
  }
  dialog::backdrop { background: rgba(0,0,0,0.6); }
  .dlg-header {
    padding: 14px 16px;
    font-weight: 600;
    color: #fff;
    /* background color is set dynamically from chosen color */
  }
  .dlg-body { padding: 14px 16px; display: grid; gap: 12px; }
  .dlg-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .dlg-row label { font-size: 14px; }
  .dlg-footer { padding: 12px 16px; display: flex; justify-content: flex-end; gap: 8px; border-top: 1px solid #2a2a2a; }
  .btn { background: #1e1e1e; color:#fff; border:1px solid #444; border-radius:6px; padding:8px 12px; cursor:pointer; }
  .btn.primary { background:#2a2a2a; border-color:#555; }
  .timers { display: grid; gap: 10px; }
  .timer-row { display:flex; align-items:center; justify-content: space-between; gap: 10px; font-size: 13px; }
  .timer-row .meta { opacity: 0.85; }
</style>
</head>
<body>
<button class="settings-btn" id="openSettings" aria-haspopup="dialog">Settings</button>
<canvas height="500" width="400" id="c"></canvas>

<dialog id="settingsDialog">
  <div class="dlg-header" id="dlgHeader">Clock Settings</div>
  <div class="dlg-body">
    <div class="dlg-row">
      <label for="colorPicker">Accent color</label>
      <input type="color" id="colorPicker" value="#005aff" />
    </div>
    <div class="dlg-row">
      <label for="keepAwake">Keep screen awake</label>
      <input type="checkbox" id="keepAwake" />
    </div>
    <div class="dlg-row" id="wakeLockNote" style="display:none;color:#bbb;">
      Screen Wake Lock not supported on this browser.
    </div>
    <hr style="border:none;border-top:1px solid #2a2a2a; margin: 6px 0;" />
    <div class="timers">
      <div class="dlg-row" style="justify-content:flex-start; gap: 10px;">
        <label for="timerMinutes" style="min-width:110px;">New timer (mins)</label>
        <input type="number" id="timerMinutes" min="1" max="360" value="25" style="width:80px;background:#1c1c1c;color:#fff;border:1px solid #333;border-radius:6px;padding:6px;">
      </div>
      <div class="dlg-row" style="justify-content:flex-start; gap: 10px;">
        <label for="timerName" style="min-width:110px;">Timer name</label>
        <input type="text" id="timerName" placeholder="auto" style="flex:1;background:#1c1c1c;color:#fff;border:1px solid #333;border-radius:6px;padding:6px;">
      </div>
      <div class="dlg-row" style="justify-content:flex-end;">
        <button class="btn primary" id="addTimer">Add Timer</button>
      </div>
      <div id="timerList" class="timers"></div>
    </div>
  </div>
  <div class="dlg-footer">
    <button class="btn" id="closeDlg">Close</button>
  </div>
  
</dialog>


<script type="text/javascript">

(function() {
         if(window.applicationCache)
         {
              if(window.applicationCache.status == 4)
              {
                  window.applicationCache.update();
                  window.applicationCache.swapCache();
              }
         }
         var hasStorage = (function() {
      		try {
      			var mod = "lame";
        		localStorage.setItem(mod, mod);
       			localStorage.removeItem(mod);
       			return true;
      		} 
      		catch(e) {
        		return false;
      		}
    	}());

         if(hasStorage) {
        	if(localStorage.getItem("clockColor") != null) {
        		var cc = localStorage.getItem("clockColor").split(",");
        		window.clockColor = [parseInt(cc[0],10),parseInt(cc[1],10),parseInt(cc[2],10)];
        	}
        	else {
        		window.clockColor = [0,90,255];
        	}
         }
         else {
         	window.clockColor = [0,90,255];
         }
    window.setClockColor = function(a) {
    	if(Array.isArray(a) == true) {
    		window.clockColor = a;
    		if(hasStorage) {
    			localStorage.setItem("clockColor",a);
    		}
    	}
    	else {
    		console.log("Error: Input is not an array");
    	}
    };

    window.getClockColor = function() {
    	if(hasStorage) {
			if(localStorage.getItem("clockColor") != null) {
				var cc = localStorage.getItem("clockColor").split(",");
				return [parseInt(cc[0],10),parseInt(cc[1],10),parseInt(cc[2],10)];
			}
			else{
				window.setClockColor([0,90,255]);
				var cc = localStorage.getItem("clockColor").split(",");
				return [parseInt(cc[0],10),parseInt(cc[1],10),parseInt(cc[2],10)];
			}
    	}
    	else {
    		return window.clockColor;
    	}
    };     
    // Utility: color conversions
    function rgbToHex(r,g,b){
      const toHex = (n)=> n.toString(16).padStart(2,'0');
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }
    function hexToRgb(hex){
      const v = hex.replace('#','');
      return [parseInt(v.slice(0,2),16), parseInt(v.slice(2,4),16), parseInt(v.slice(4,6),16)];
    }

    // Timers state and helpers
    function loadTimers(){
      try { return JSON.parse(localStorage.getItem('clockTimers')||'[]'); } catch(e){ return []; }
    }
    function saveTimers(arr){ localStorage.setItem('clockTimers', JSON.stringify(arr)); }
    function formatHM(ms){
      var total = Math.max(0, Math.floor(ms/1000));
      var h = Math.floor(total/3600);
      var m = Math.floor((total%3600)/60);
      var s = total%60;
      function pad(n){ return (n<10?'0':'')+n; }
      return h>0 ? (pad(h)+':'+pad(m)+':'+pad(s)) : (pad(m)+':'+pad(s));
    }
    function nowTs(){ return Date.now(); }

    // Manage pause/resume
    function getRemainingMs(t){
      if (t.paused) return Math.max(0, t.remainingMs||0);
      return Math.max(0, (t.endTs||0) - nowTs());
    }
    function isActiveTimer(t){
      return getRemainingMs(t) > 0; // paused with remaining time or counting down
    }
    function pauseTimer(t){
      if (t.paused) return t;
      var rem = getRemainingMs(t);
      t.paused = true; t.remainingMs = rem;
      return t;
    }
    function resumeTimer(t){
      if (!t.paused) return t;
      var rem = Math.max(0, t.remainingMs||0);
      t.paused = false; delete t.remainingMs;
      t.endTs = nowTs() + rem;
      return t;
    }

    // Notification for completed timers
    async function notifyCompletedTimers(){
      var arr = loadTimers();
      var changed = false;
      for (var i=0;i<arr.length;i++){
        var t = arr[i];
        if (!t) continue;
        if (t.notified) continue;
        if (nowTs() >= t.endTs){
          // Attempt Notification API
          var title = 'Timer finished';
          var body = (t.name || 'timer') + ' is complete';
          var didNotify = false;
          try {
            if ('Notification' in window){
              if (Notification.permission === 'granted'){
                var n = new Notification(title, { body: body, tag: 'digital-clock-'+t.id });
                n.onclick = function(){ try { window.focus(); } catch(e){} };
                didNotify = true;
              } else if (Notification.permission === 'default'){
                var res = await Notification.requestPermission();
                if (res === 'granted'){
                  var n2 = new Notification(title, { body: body, tag: 'digital-clock-'+t.id });
                  n2.onclick = function(){ try { window.focus(); } catch(e){} };
                  didNotify = true;
                }
              }
            }
          } catch(e){ /* ignore */ }
          if (!didNotify){
            try { alert(body); } catch(e){}
          }
          t.notified = true;
          changed = true;
        }
      }
      if (changed) saveTimers(arr);
    }

    var c   = document.getElementById('c'), //Get the canvas element
	    ctx = c.getContext("2d"); //select the canvas.context
	    
    var BASE_W = 400, BASE_H = 500; // logical drawing space
    var CUR_SCALE = 1, CUR_OFFX = 0, CUR_OFFY = 0; // for hit-testing

    // Prepare canvas backing store for current CSS size and DPR, center content
    function setupCanvasForDPR(){
      var dpr = window.devicePixelRatio || 1;
      var rect = c.getBoundingClientRect();
      var cssW = rect.width;
      var cssH = rect.height;
      // Set backing resolution
      var targetW = Math.max(1, Math.round(cssW * dpr));
      var targetH = Math.max(1, Math.round(cssH * dpr));
      if (c.width !== targetW) c.width = targetW;
      if (c.height !== targetH) c.height = targetH;

      // Compute scale to fit BASE_W x BASE_H into CSS box
      var scale = Math.min(cssW / BASE_W, cssH / BASE_H);
      var offsetX = (cssW - BASE_W * scale) / 2;
      var offsetY = (cssH - BASE_H * scale) / 2;
      CUR_SCALE = scale; CUR_OFFX = offsetX; CUR_OFFY = offsetY;
      // Reset and apply transform: first scale by DPR, then by logical scale, then translate to center
      ctx.setTransform(1,0,0,1,0,0);
      ctx.setTransform(dpr * scale, 0, 0, dpr * scale, dpr * offsetX, dpr * offsetY);
    }

    //##########################
	//Format the date accordingly 
	//that if the value is less
	//than 10 then instead of 
	//printing "1"	print "01"
	//@RETURNS Array [[string,string,string],[string,string,string]]
	//##########################
	var createFormattedDate = function(d){ //UTIL function
		var	h  = d.getHours(), // get hours, seconds, minutes, year, day , month
			s  = d.getSeconds(),
			m  = d.getMinutes(),
			y  = d.getFullYear(),
			mn = (d.getMonth() + 1),
			dt = d.getDate(),
			dy;
		if(d.getHours() < 10)
		{
			h = 0 + d.getHours().toString();
		}
		if(d.getSeconds() < 10)
		{
			s = 0 + d.getSeconds().toString();
		}
		if(d.getMinutes() < 10)
		{
			m = 0 + d.getMinutes().toString();
		}
		if((d.getMonth()+1) < 10)
		{
			mn = 0 + (d.getMonth()+1).toString();
		}
		if(d.getDate() < 10)
		{
			dt = 0 + d.getDate().toString();
		}


		return [[h,m,s],[dt,mn,y]];


	};


	var getWeekdayFormatted = function(d){
		var dy;
		switch(d.getDay())
		{
			case 1:
				dy = "MON                        ";
			break;
			case 2:
				dy = "    TUE                    ";
			break;
			case 3:
				dy = "        WED                ";
			break;
			case 4:
				dy = "            THU            ";
			break;
			case 5:
				dy = "                FRI        ";
			break;
			case 6:
				dy = "                    SAT    ";
			break;
			case 0:
				dy = "                        SUN";
			break;
			default:
				dy = "                            UKN";
			break;
		};


		return dy;
	};


	// Render one tick (draw once)
	var r = function(){
		setupCanvasForDPR();
		var dt = new Date();
		var cC = window.getClockColor();
		//Get the date
		var d = createFormattedDate(dt);
	        //clear the board in logical units
		ctx.clearRect(0,0,BASE_W,BASE_H);
		//save the font
		ctx.font = "70pt Digital7Mono";
		//create a background for time
		ctx.fillStyle ="rgba(" + cC[0] + "," + cC[1] + "," + cC[2] + ",0.3)";
		ctx.fillText("88:88:88",10,210);
		//add the time
		ctx.fillStyle = "rgb(" + cC[0] + "," + cC[1] + "," + cC[2] + ")"; 
		ctx.fillText(d[0][0] + ":" + d[0][1] + ":" + d[0][2],10,210);
		//save the font and change the size 
		ctx.font = "50pt Digital7Mono";
		//create background
		ctx.fillStyle = "rgba(" + cC[0] + "," + cC[1] + "," + cC[2] + ",0.3)";
		ctx.fillText("88:88:8888",25,125);
		//DEFINED
		ctx.fillStyle = "rgb(" + cC[0] + "," + cC[1] + "," + cC[2] + ")";
		ctx.fillText( d[1][0] + ":" + d[1][1] + ":" + d[1][2], 25, 125 );
		//Display which day is it eg "WED"
		//Create a background
		ctx.font = "20pt Digital7Mono";
		ctx.fillStyle = "rgba(" + cC[0] + "," + cC[1] + "," + cC[2] + ",0.2)";
		ctx.fillText("888 888 888 888 888 888 888",20, 265);
		//Now put a light layer of the days
		ctx.fillStyle = "rgba(" + cC[0] + "," + cC[1] + "," + cC[2] + ",0.4)";
		ctx.fillText("MON TUE WED THU FRI SAT SUN",20, 265);
		//Now get the weekday and display without transparency
		ctx.fillStyle = "rgb(" + cC[0] + "," + cC[1] + "," + cC[2] + ")";
		ctx.fillText(getWeekdayFormatted(dt),20,265);

		// Draw up to 3 active timers below the date with controls
		var timers = loadTimers();
		var active = timers.filter(isActiveTimer).sort(function(a,b){
		  var aKey = a.paused ? Number.MAX_SAFE_INTEGER : (a.endTs||Number.MAX_SAFE_INTEGER);
		  var bKey = b.paused ? Number.MAX_SAFE_INTEGER : (b.endTs||Number.MAX_SAFE_INTEGER);
		  return aKey - bKey;
		}).slice(0,3);
		ctx.font = "18pt Digital7Mono";
		var y = 300;
		window.__timerHitAreas = [];
		active.forEach(function(t){
		  var rem = getRemainingMs(t);
		  var txt = (t.name||'timer') + '  ' + formatHM(rem);
		  // Backdrop for the full line (name + time)
		  ctx.fillStyle = "rgba(" + cC[0] + "," + cC[1] + "," + cC[2] + ",0.25)";
		  ctx.fillText("888888888888888888888  88888",20,y);
		  // Foreground text
		  ctx.fillStyle = "rgb(" + cC[0] + "," + cC[1] + "," + cC[2] + ")";
		  ctx.fillText(txt,20,y);
		  // Controls: pause/resume and clear (right side)
		  var btnY = y;
		  var toggleLabel = t.paused ? "|>" : "||";
		  var toggleX = BASE_W - 60; // left control
		  var clearX = BASE_W - 20;  // right control
		  ctx.fillText(toggleLabel, toggleX, btnY);
		  ctx.fillText("X", clearX, btnY);
		  // Record hit areas (approximate boxes around text in logical coords)
		  window.__timerHitAreas.push({ id: t.id, action: 'toggle', x: toggleX - 8, y: btnY - 20, w: 30, h: 24 });
		  window.__timerHitAreas.push({ id: t.id, action: 'clear',  x: clearX - 8,  y: btnY - 20, w: 24, h: 24 });
		  y += 28;
		});
	};

	// Schedule next update aligned to next second boundary
	function scheduleNextTick(){
	  var now = new Date();
	  var delay = 1000 - now.getMilliseconds();
  setTimeout(function(){
    r();
    // Check for any completed timers and notify once
    notifyCompletedTimers();
    // Update dialog timer list if open
    try { if (typeof dlg !== 'undefined' && dlg.open) { renderTimerList(); } } catch(e) {}
    scheduleNextTick();
  }, delay);
  }

	// Redraw on resize/orientation to adapt DPR and size instantly
	window.addEventListener('resize', r);
  window.addEventListener('orientationchange', r);

	// Canvas hit testing for timer controls
	function toLogicalCoords(evt){
	  var rect = c.getBoundingClientRect();
	  var cssX = evt.clientX - rect.left;
	  var cssY = evt.clientY - rect.top;
	  var lx = (cssX - CUR_OFFX) / CUR_SCALE;
	  var ly = (cssY - CUR_OFFY) / CUR_SCALE;
	  return { x: lx, y: ly };
	}

	c.addEventListener('click', function(evt){
	  if (!window.__timerHitAreas || window.__timerHitAreas.length === 0) return;
	  var p = toLogicalCoords(evt);
	  for (var i=0;i<window.__timerHitAreas.length;i++){
	    var h = window.__timerHitAreas[i];
	    if (p.x >= h.x && p.x <= h.x+h.w && p.y >= h.y && p.y <= h.y+h.h){
	      var arr = loadTimers();
	      var idx = arr.findIndex(function(t){ return t.id === h.id; });
	      if (idx === -1) return;
	      var t = arr[idx];
	      if (h.action === 'clear'){
	        arr.splice(idx,1);
	      } else if (h.action === 'toggle'){
	        // Toggle pause/resume only if time remains
	        if (getRemainingMs(t) <= 0){ /* ignore */ }
	        else if (t.paused) resumeTimer(t); else pauseTimer(t);
	        arr[idx] = t;
	      }
	      saveTimers(arr);
	      r();
	      try { if (dlg.open) renderTimerList(); } catch(e){}
	      break;
	    }
	  }
	});

	// Dialog wiring (color + wake lock)
	var openBtn = document.getElementById('openSettings');
	var dlg = document.getElementById('settingsDialog');
	var dlgHeader = document.getElementById('dlgHeader');
	var colorInput = document.getElementById('colorPicker');
	var closeDlg = document.getElementById('closeDlg');
	var keepAwakeCheckbox = document.getElementById('keepAwake');
	var wakeLockNote = document.getElementById('wakeLockNote');
    var timerMinutes = document.getElementById('timerMinutes');
    var timerNameInput = document.getElementById('timerName');
    var addTimerBtn = document.getElementById('addTimer');
    var timerList = document.getElementById('timerList');

	function applyHeaderColor(){
	  var cC = window.getClockColor();
	  dlgHeader.style.backgroundColor = 'rgb(' + cC[0] + ',' + cC[1] + ',' + cC[2] + ')';
	}

	// Initialize color input from stored color
	(function initColorUI(){
	  var cC = window.getClockColor();
	  colorInput.value = rgbToHex(cC[0], cC[1], cC[2]);
	  applyHeaderColor();
	})();

    function defaultTimerName(mins){
      var d = new Date();
      var hh = String(d.getHours()).padStart(2,'0');
      var mm = String(d.getMinutes()).padStart(2,'0');
      return 'timer ' + hh + ':' + mm + ' + ' + mins + ' mins';
    }

    function renderTimerList(){
      var timers = loadTimers();
      timerList.innerHTML = '';
      if (timers.length === 0){
        var empty = document.createElement('div');
        empty.className = 'timer-row';
        empty.style.opacity = '0.8';
        empty.textContent = 'No timers set';
        timerList.appendChild(empty);
        return;
      }
      timers.slice(0,3).forEach(function(t){
        var row = document.createElement('div');
        row.className = 'timer-row';
        var rem = getRemainingMs(t);
        var status = t.paused ? ('paused ' + formatHM(rem)) : (rem > 0 ? ('in ' + formatHM(rem)) : 'completed');
        var left = document.createElement('div');
        left.textContent = (t.name||'timer');
        var right = document.createElement('div');
        right.className = 'meta';
        right.textContent = status;
        var clr = document.createElement('button');
        clr.className = 'btn';
        clr.textContent = 'Clear';
        clr.addEventListener('click', function(){ 
          var arr = loadTimers().filter(function(x){ return x.id !== t.id; });
          saveTimers(arr);
          renderTimerList();
          r();
        });
        row.appendChild(left);
        row.appendChild(right);
        row.appendChild(clr);
        timerList.appendChild(row);
      });
    }

    function tryOpenPromptIfNoTimers(){
      var timers = loadTimers();
      if (timers.length === 0 && typeof dlg.showModal === 'function') {
        timerMinutes.value = 25;
        timerNameInput.placeholder = defaultTimerName(25);
        dlg.showModal();
      }
    }

	openBtn.addEventListener('click', function(){
	  applyHeaderColor();
	  if (typeof dlg.showModal === 'function') dlg.showModal();
	});
	closeDlg.addEventListener('click', function(){ dlg.close(); });
	colorInput.addEventListener('input', function(){
	  var rgb = hexToRgb(colorInput.value);
	  window.setClockColor(rgb);
	  applyHeaderColor();
	  r();
	});

    // Update default name placeholder when minutes change
    timerMinutes.addEventListener('input', function(){
      var v = parseInt(timerMinutes.value,10);
      if (v>0) timerNameInput.placeholder = defaultTimerName(v);
    });

    // Timers: Add
    addTimerBtn.addEventListener('click', function(){
      var mins = parseInt(timerMinutes.value,10);
      if (!(mins>0)) { alert('Enter minutes > 0'); return; }
      var arr = loadTimers();
      if (arr.length >= 3) { alert('Maximum of 3 timers. Clear one to add.'); return; }
      var name = timerNameInput.value && timerNameInput.value.trim().length>0 ? timerNameInput.value.trim() : defaultTimerName(mins);
      var endTs = Date.now() + mins*60*1000;
      arr.push({ id: 't'+endTs+Math.random().toString(16).slice(2), name: name, endTs: endTs });
      saveTimers(arr);
      timerNameInput.value = '';
      renderTimerList();
      r();
    });

	// Wake Lock (Keep Awake)
	var wakeLock = null;
	var keepAwakeEnabled = false;
	if (!('wakeLock' in navigator)) {
	  wakeLockNote.style.display = 'block';
	}

	async function requestWakeLock(){
	  try {
	    wakeLock = await navigator.wakeLock.request('screen');
	    wakeLock.addEventListener('release', function(){
	      if (keepAwakeEnabled && document.visibilityState === 'visible') {
	        var retry = confirm('Screen wake lock was released. Re-enable?');
	        if (retry) requestWakeLock();
	      }
	    });
	  } catch (e) {
	    console.warn('Wake Lock request failed:', e);
	    var retry = confirm('Unable to keep screen awake. Try again?');
	    if (retry) requestWakeLock();
	  }
	}

	function releaseWakeLock(){
	  try { if (wakeLock) { wakeLock.release(); } } catch(e) {}
	  wakeLock = null;
	}

	keepAwakeCheckbox.addEventListener('change', function(){
	  keepAwakeEnabled = keepAwakeCheckbox.checked;
	  if (keepAwakeEnabled && 'wakeLock' in navigator) {
	    requestWakeLock();
	  } else {
	    releaseWakeLock();
	  }
	});

	document.addEventListener('visibilitychange', function(){
	  if (document.visibilityState === 'visible' && keepAwakeEnabled && 'wakeLock' in navigator) {
	    requestWakeLock();
	  }
	});

  // Initial draw and start 1-second ticking
  r();
  // Notify immediately if any timers already completed while away
  notifyCompletedTimers();
  scheduleNextTick();
	// Initialize UI lists and maybe prompt for default timer
	renderTimerList();
	tryOpenPromptIfNoTimers();
})();
</script>
</body>
</html>

 
